#!/bin/bash

# Color Codes (use printf-safe format)
#################
# Terminal Colors
#################

###
# Regular
###
color_regular_black='\033[0;30m'
color_regular_red='\033[0;31m'
color_regular_green='\033[0;32m'
color_regular_yellow='\033[0;33m'
color_regular_blue='\033[0;34m'
color_regular_purple='\033[0;35m'
color_regular_cyan='\033[0;36m'
color_regular_white='\033[0;37m'

###
# Bold
###
color_bold_black='\033[1;30m'
color_bold_red='\033[1;31m'
color_bold_green='\033[1;32m'
color_bold_yellow='\033[1;33m'
color_bold_blue='\033[1;34m'
color_bold_purple='\033[1;35m'
color_bold_cyan='\033[1;36m'
color_bold_white='\033[1;37m'

###
# Underline
###
color_underline_black='\033[4;30m'
color_underline_red='\033[4;31m'
color_underline_green='\033[4;32m'
color_underline_yellow='\033[4;33m'
color_underline_blue='\033[4;34m'
color_underline_purple='\033[4;35m'
color_underline_cyan='\033[4;36m'
color_underline_white='\033[4;37m'

###
# Background
###
color_background_black='\033[40m'
color_background_red='\033[41m'
color_background_green='\033[42m'
color_background_yellow='\033[43m'
color_background_blue='\033[44m'
color_background_purple='\033[45m'
color_background_cyan='\033[46m'
color_background_white='\033[47m'

color_reset='\033[0m'

###########
# Functions
###########

function message_failure() {
    printf "${color_bold_white}${color_background_red} ğŸ¤¦  $1 ${color_reset}\n"
}

function message_success() {
    printf "${color_bold_black}${color_background_green} $1 ğŸº  ${color_reset}\n"
}

function message_warning() {
    printf "${color_bold_black}${color_background_yellow} âš ï¸ $1 ${color_reset}\n"
}

function message_info() {
    printf "${color_bold_black}${color_background_blue} â˜ï¸ï¸  $1 ${color_reset}\n"
}

printf "${color_regular_blue}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${color_reset}\n"
printf "${color_regular_yellow}ğŸ§¹ Running Pre-Commit Quality Checks...${color_reset}\n"
printf "${color_regular_blue}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${color_reset}\n\n"

set -e
VENDOR_BIN="./vendor/bin"

# 1) Laravel Pint
printf "${color_regular_green}â†’ Step 1: Laravel Pint (Auto Formatting)${color_reset}\n"
printf "${color_regular_blue}Command:${color_reset} $VENDOR_BIN/pint --parallel\n"
$VENDOR_BIN/pint --config pint.json
printf "\n"

# 2) PHP CS Fixer
# printf "${color_regular_green}â†’ Step 2: PHP-CS-Fixer (More Formatting)${color_reset}\n"
# printf "${color_regular_blue}Command:${color_reset} php-cs-fixer fix \n"
# php-cs-fixer fix
# printf "\n"

# 3) PHP CodeSniffer
# printf "${color_regular_green}â†’ Step 3: PHP_CodeSniffer (Coding Standards)${color_reset}\n"
# printf "${color_regular_blue}Command:${color_reset} phpcs --standard=PSR12 app/ routes/ tests/\n"
# phpcs --standard=PSR12 app/ config/ database/ resources/ routes/ stubs/ tests/
# printf "\n"

# 4) PHP Mess Detector
# printf "${color_regular_green}â†’ Step 4: PHP Mess Detector (Complexity & Smells)${color_reset}\n"
# printf "${color_regular_blue}Command:${color_reset} phpmd app text phpmd.xml\n"
# phpmd app,config,database,resources,routes,tests,stubs text phpmd.xml || {
#     printf "${RED}âœ– PHP Mess Detector found issues. Commit aborted.${color_reset}\n"
#     exit 1
# }
# printf "\n"

# 5) Larastan (PHPStan)
# printf "${color_regular_green}â†’ Step 5: Larastan / PHPStan (Static Analysis)${color_reset}\n"
# printf "${color_regular_blue}Command:${color_reset} $VENDOR_BIN/phpstan analyse --memory-limit=1G\n"
# $VENDOR_BIN/phpstan analyse --memory-limit=1G
# printf "\n"
printf "â†’ PHPStan (only staged files)\n"
STAGED=$(git diff --cached --name-only --diff-filter=ACMR | grep '\.php$' || true)
if [ -n "$STAGED" ]; then
    $VENDOR_BIN/phpstan analyse --memory-limit=1G --error-format=table -- $STAGED
fi

printf "${color_regular_blue}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${color_reset}\n"
printf "${color_regular_green}âœ… All checks passed. Commit will continue!${color_reset}\n"
printf "${color_regular_blue}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${color_reset}\n"

exit 1
